Code here is copied verbatim from typescript's source code.

tag v2.7.1

Goal is to keep this code as verbatim as possible, only commenting out a few lines as necessary.